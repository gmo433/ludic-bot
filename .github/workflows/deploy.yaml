name: Build and Deploy Ludic Bot

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    # 1Ô∏è‚É£ –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
    - name: Checkout repo
      uses: actions/checkout@v4

    # 2Ô∏è‚É£ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Go
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: 1.20

    # 3Ô∏è‚É£ –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º go.sum –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
    - name: Generate go.sum if missing
      run: |
        if [ ! -f go.sum ]; then
          echo "go.sum not found, generating..."
          go mod tidy
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add go.sum
          git commit -m "Auto-generate go.sum"
          git push
        else
          echo "go.sum exists, skipping generation"
        fi

    # 4Ô∏è‚É£ –°–æ–±–∏—Ä–∞–µ–º Docker –æ–±—Ä–∞–∑
    - name: Build Docker image
      run: |
        docker build -t ludic-bot:latest .
        docker tag ludic-bot:latest ${{ secrets.DOCKERHUB_USERNAME }}/ludic-bot:latest

    # 5Ô∏è‚É£ –õ–æ–≥–∏–Ω–∏–º—Å—è –≤ Docker Hub
    - name: Log in to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    # 6Ô∏è‚É£ –ü—É—à–∏–º Docker –æ–±—Ä–∞–∑
    - name: Push Docker image
      run: |
        docker push ${{ secrets.DOCKERHUB_USERNAME }}/ludic-bot:latest

    # 7Ô∏è‚É£ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º kubectl
    - name: Set up kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'latest'

    # 8Ô∏è‚É£ –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ –∫–ª–∞—Å—Ç–µ—Ä—É —á–µ—Ä–µ–∑ KUBECONFIG
    - name: Set KUBECONFIG
      run: |
        echo "${{ secrets.KUBECONFIG }}" > kubeconfig
        export KUBECONFIG=$(pwd)/kubeconfig

    # 9Ô∏è‚É£ –î–µ–ø–ª–æ–π PostgreSQL
    - name: Deploy PostgreSQL
      run: kubectl apply -f k8s/postgres-deployment.yaml

    # üîü –î–µ–ø–ª–æ–π Secrets
    - name: Deploy Secrets
      run: kubectl apply -f k8s/ludic-bot-secrets.yaml

    # 1Ô∏è‚É£1Ô∏è‚É£ –î–µ–ø–ª–æ–π Ludic Bot (5 Pods)
    - name: Deploy Ludic Bot
      run: |
        sed -i "s|<dockerhub-username>|${{ secrets.DOCKERHUB_USERNAME }}|g" k8s/ludic-bot-deployment.yaml
        kubectl apply -f k8s/ludic-bot-deployment.yaml
